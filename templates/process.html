{% extends "layout.html" %}
{% block content %}
<div class="fade-in" style="max-width: 700px; margin: 4rem auto; text-align: center;">
    
    <div id="loadingZone">
        <div style="margin-bottom: 2rem;">
            <div style="width: 60px; height: 60px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
        <h2 style="margin-bottom: 0.5rem;">Production en cours...</h2>
        <p style="margin-bottom: 2rem;">Nos GPU g√©n√®rent votre vid√©o haute d√©finition.</p>

        <div class="terminal-log" id="logs">
            <div style="opacity: 0.5; margin-bottom: 8px;">> Initialisation session... OK</div>
        </div>
    </div>

    <div id="resultZone" style="display: none;">
        <h1 style="background: linear-gradient(to right, #10b981, #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 2rem;">
            ‚ú® Vid√©o Termin√©e !
        </h1>
        
        <div class="card" style="padding: 12px; display: inline-block; box-shadow: var(--shadow-float);">
            <video id="finalVideo" controls autoplay style="display: block; width: 100%; max-width: 320px; border-radius: var(--radius-sm);"></video>
        </div>

        <div style="margin-top: 3rem; display: flex; gap: 16px; justify-content: center;">
            <a id="dlBtn" class="btn btn-primary" download>
                üì• T√©l√©charger .MP4
            </a>
            <a href="/" class="btn btn-secondary">
                üîÑ Nouveau Projet
            </a>
        </div>
    </div>
</div>

<style> @keyframes spin { 100% { transform: rotate(360deg); } } </style>

<script>
    const fakeLogs = [
        "Connexion √† l'API Kling v1.6 Pro...",
        "Analyse de la structure narrative...",
        "G√©n√©ration des images cl√©s (Flux)...",
        "Synth√®se vocale neuronale (Minimax)...",
        "Animation Image-to-Video en cours...",
        "Assemblage FFmpeg & Mixage Audio...",
        "Finalisation du rendu..."
    ];
    
    let logIdx = 0;
    const logInterval = setInterval(() => {
        if(logIdx < fakeLogs.length) {
            const div = document.createElement('div');
            div.innerText = `> ${fakeLogs[logIdx]}`;
            div.style.animation = "fadeIn 0.3s forwards";
            document.getElementById('logs').appendChild(div);
            document.getElementById('logs').scrollTop = 9999;
            logIdx++;
        }
    }, 4500);

    window.onload = async () => {
        try {
            const res = await fetch('/api/render', {method: 'POST'});
            const data = await res.json();
            
            clearInterval(logInterval);
            document.getElementById('loadingZone').style.display = 'none';
            document.getElementById('resultZone').style.display = 'block';
            document.getElementById('finalVideo').src = data.url;
            document.getElementById('dlBtn').href = data.url;
        } catch(e) {
            alert("Erreur critique lors du rendu.");
        }
    };
</script>
{% endblock %}